const fs = require('fs');
const path = require('path');
const matter = require('gray-matter');

const BLOG_DIR = 'blog';
const root = path.resolve(__dirname, '..');
const blogPath = path.join(root, 'public', BLOG_DIR);
const outputPath = path.join(root, 'src', 'app', 'shared', 'data', 'blog-manifest.ts');

// Ensure the data directory exists
const dataDir = path.dirname(outputPath);
if (!fs.existsSync(dataDir)) {
  fs.mkdirSync(dataDir, { recursive: true });
}

fs.readdir(blogPath, (err, files) => {
  if (err) {
    return console.error('Error reading blog directory:', err);
  }
  
  const markdownFiles = files
    .filter(file => file.endsWith('.md'))
    .map(file => `${file}`);

  if (markdownFiles?.length === 0) {
    return console.error('No markdown files found in the blog directory.');
  }

  const manifest = {
    files: markdownFiles.map(file => {
      const filePath = path.join(blogPath, file);
      const fileContent = fs.readFileSync(filePath, 'utf8');
      const { data } = matter(fileContent);
      return {
        fileName: file,
        ...data
      };
    })
  };

  // Generate TypeScript file content
  const tsContent = `// This file is auto-generated by npm-functions/generate-blog-manifest-ts.js
// Do not edit manually - regenerate using: npm run blog:update-manifest

export const BLOG_MANIFEST = ${JSON.stringify(manifest, null, 2)} as const;
`;

  // Write the TypeScript file
  fs.writeFileSync(outputPath, tsContent);
  console.log('TypeScript blog manifest generated successfully at:', outputPath);
  
  // Also write the JSON manifest for backward compatibility
  const manifestPath = path.join(blogPath, 'manifest.json');
  fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
  console.log('JSON manifest updated for backward compatibility.');
});